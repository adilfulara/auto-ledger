name: Deploy Staging

on:
  # Auto-deploy after CI passes (main OR feature branches)
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches:
      - main
      - 'feat/**'
      - 'fix/**'

  # Manual trigger for rollback/adhoc deploys
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., staging, sha-abc123, branch-feat-issue-33)'
        required: true
        default: 'staging'

env:
  FLY_REGISTRY: registry.fly.io
  FLY_APP_NAME: auto-ledger-staging

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    # Skip build for manual dispatch (uses existing image)
    if: github.event_name != 'workflow_dispatch' && github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.set-tag.outputs.tag }}
      sha_tag: ${{ steps.set-tag.outputs.sha_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the commit that triggered CI
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Determine image tag
        id: set-tag
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA=$(echo "$SHA" | cut -c1-7)

          # Query for PR number if this is a feature branch
          PR_NUM=""
          if [ "$BRANCH" != "main" ]; then
            # Query GitHub API for PR from branch (state=all to find merged PRs too)
            PR_RESULT=$(curl -s \
              -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH&state=all" \
              | jq -r '.[0].number // empty')
            PR_NUM="$PR_RESULT"
          fi

          if [ "$BRANCH" = "main" ]; then
            # Main branch - use main-sha format
            echo "tag=main-$SHORT_SHA" >> $GITHUB_OUTPUT
            echo "sha_tag=" >> $GITHUB_OUTPUT
          elif [ -n "$PR_NUM" ]; then
            # PR branch - use pr-number-sha format
            echo "tag=pr-$PR_NUM-$SHORT_SHA" >> $GITHUB_OUTPUT
            echo "sha_tag=" >> $GITHUB_OUTPUT
          else
            # Fallback if PR number not found - sanitize branch name for Docker tag
            SANITIZED_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g')
            echo "tag=branch-$SANITIZED_BRANCH-$SHORT_SHA" >> $GITHUB_OUTPUT
            echo "sha_tag=" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Fly Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.FLY_REGISTRY }}
          username: x
          password: ${{ secrets.FLY_API_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.FLY_REGISTRY }}/${{ env.FLY_APP_NAME }}:${{ steps.set-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Fly.io Staging
    runs-on: ubuntu-latest
    needs: [build]
    # Run deploy even if build was skipped (manual dispatch)
    if: always() && (needs.build.result == 'success' || needs.build.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Determine image tag
        id: image
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ needs.build.outputs.image_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Fly.io
        run: |
          flyctl deploy \
            --config fly.staging.toml \
            --image ${{ env.FLY_REGISTRY }}/${{ env.FLY_APP_NAME }}:${{ steps.image.outputs.tag }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Post deployment info
        run: |
          echo "## üöÄ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.FLY_REGISTRY }}/${{ env.FLY_APP_NAME }}:${{ steps.image.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://auto-ledger-staging.fly.dev" >> $GITHUB_STEP_SUMMARY

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          curl -f https://auto-ledger-staging.fly.dev/actuator/health || echo "‚ö†Ô∏è Health check pending (machine may still be starting up)"
